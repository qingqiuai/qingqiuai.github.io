<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>漫画阅读器</title>
    <style>
        #comic {
            /* overflow-y: scroll; */
            overflow-x: hidden;
            white-space: normal;
            height: auto; /* 根据需要调整 */
        }
        .comic-page {
            page-break-after: always;
            padding: 10px;
            text-align: center;
        }
        .comic-page img {
            max-width: 100%;
            max-height: 100%;
        }
        #loading {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="loading">加载中...</div>
    <div id="comic"></div>
    <url id="" type="url" status="" title="" wc=""><script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script></url> 
    <script>
        var urlParams = new URLSearchParams(window.location.search);
        var comicUrl = urlParams.get('comic_url');
        var currentPageIndex = 0;
        var pageCount = 0;
        var comicContainer = document.getElementById("comic");
        var loadingElement = document.getElementById("loading");

        function loadComic() {
            loadingElement.style.display = 'block';
            fetch(comicUrl)
                .then(response => response.blob())
                .then(blob => JSZip.loadAsync(blob))
                .then(zip => {
                    var filenames = Object.keys(zip.files).filter(name => !zip.files[name].dir);
                    // 确保文件名按顺序排序
                    filenames.sort((a, b) => {
                        var numA = parseInt(a.replace(/[^0-9]/g, ''), 10);
                        var numB = parseInt(b.replace(/[^0-9]/g, ''), 10);
                        return numA - numB;
                    });
                    pageCount = filenames.length;
                    // 从第一张图片开始加载
                    displayImage(filenames[currentPageIndex], zip);
                    loadingElement.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("加载漫画失败");
                });
        }

        function displayImage(filename, zip) {
            var pageDiv = document.createElement("div");
            pageDiv.className = "comic-page";
            // 异步加载图片数据
            var img = zip.file(filename).async("base64");
            img.then(function(base64) {
                var imgElement = new Image();
                imgElement.src = "data:image/jpeg;base64," + base64;
                pageDiv.appendChild(imgElement);
                // 始终将新页面添加到容器的末尾
                comicContainer.appendChild(pageDiv);
            }).catch(function(error) {
                console.error('Error:', error);
            });
        }

        // 监听滚动事件，以便加载上一张或下一张图片
        comicContainer.addEventListener('scroll', function() {
            var scrollTop = comicContainer.scrollTop;
            var scrollHeight = comicContainer.scrollHeight;
            var clientHeight = comicContainer.clientHeight;

            // 如果滚动到接近容器顶部，加载上一张图片
            if (scrollTop <= 0) {
                if (currentPageIndex > 0) {
                    var prevPageFilename = Object.keys(zip.files)[currentPageIndex - 1];
                    displayImage(prevPageFilename, zip);
                    currentPageIndex--;
                }
            }

            // 如果滚动到接近容器底部，加载下一张图片
            if (scrollTop + clientHeight >= scrollHeight) {
                if (currentPageIndex < pageCount - 1) {
                    var nextPageFilename = Object.keys(zip.files)[currentPageIndex + 1];
                    displayImage(nextPageFilename, zip);
                    currentPageIndex++;
                }
            }
        });

        // 页面加载后自动加载漫画
        loadComic();
    </script>
</body>
</html>
