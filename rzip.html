<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>漫画阅读器</title>
    <style>
        #comic {
            /* overflow-y: scroll; */
            overflow-x: hidden;
            white-space: normal;
            height: auto; /* 根据需要调整 */
        }
        .comic-page {
            page-break-after: always;
            padding: 10px;
            text-align: center;
        }
        .comic-page img {
            max-width: 100%;
            max-height: 100%;
        }
        #loading {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="loading">加载中...</div>
    <div id="comic"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script>
        var urlParams = new URLSearchParams(window.location.search);
        var comicUrl = urlParams.get('comic_url');
        // 将filenames定义为全局变量
        var filenames = [];
        var currentPageIndex = 0;
        var pageCount = 0;
        var zip = null; // 将zip作为全局变量
        var comicContainer = document.getElementById("comic");
        var loadingElement = document.getElementById("loading");
    
        function loadComic() {
            loadingElement.style.display = 'block';
            fetch(comicUrl)
                .then(response => response.blob())
                .then(blob => JSZip.loadAsync(blob))
                .then(zipFile => {
                    zip = zipFile;
                    var filenamesLocal = Object.keys(zip.files).filter(name => !zip.files[name].dir);
                    filenamesLocal.sort((a, b) => parseInt(a) - parseInt(b)); // 确保数字顺序排序
                    pageCount = filenamesLocal.length;
                    filenames = filenamesLocal; // 更新全局变量filenames
                    // 预先加载一些图片以便于滚动时使用
                    loadNextImages(5); // 这里加载前5张图片作为起始
                    loadingElement.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("加载漫画失败");
                });
        }

        function displayImage(filename) {
            var pageDiv = document.createElement("div");
            pageDiv.className = "comic-page";
            var imgElement = new Image();
            imgElement.onload = function() {
                pageDiv.appendChild(imgElement);
                comicContainer.appendChild(pageDiv); // 添加到容器末尾
            };
            imgElement.src = 'path/to/image/' + filename; // 替换为实际的图片路径
        }

        function loadNextImages(count) {
            var loadCount = 0;
            var loadNext = () => {
                if (currentPageIndex < pageCount && loadCount < count) {
                    displayImage(filenames[currentPageIndex]);
                    currentPageIndex++;
                    loadCount++;
                    setTimeout(loadNext, 10); // 很小的延迟来连续加载图片
                }
            };
            loadNext();
        }

        // 移除原有的滚动事件监听器
        // comicContainer.addEventListener('scroll', function() {...});

        // 页面加载后自动加载漫画
        loadComic();
    </script>
</body>
</html>
