<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>漫画阅读器</title>
    <style>
        #comic {
            /* overflow-y: scroll; */
            overflow-x: hidden;
            white-space: normal;
            height: auto; /* 根据需要调整 */
        }
        .comic-page {
            page-break-after: always;
            padding: 10px;
            text-align: center;
        }
        .comic-page img {
            max-width: 100%;
            max-height: 100%;
        }
        #loading {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="loading">加载中...</div>
    <div id="comic"></div>
    <script src="<url id="" type="url" status="" title="" wc="">https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script></url> 
<script>
    var urlParams = new URLSearchParams(window.location.search);
    var comicUrl = urlParams.get('comic_url');
    var currentPageIndex = 0;
    var pageCount = 0;
    var zip = null; // 将zip作为全局变量
    var comicContainer = document.getElementById("comic");
    var loadingElement = document.getElementById("loading");

    function loadComic() {
        loadingElement.style.display = 'block';
        fetch(comicUrl)
            .then(response => response.blob())
            .then(blob => JSZip.loadAsync(blob))
            .then(zipFile => {
                zip = zipFile; // 更新全局变量zip
                var filenames = Object.keys(zip.files).filter(name => !zip.files[name].dir);
                filenames.sort(); // 如果文件名已经有序，可以移除此行
                pageCount = filenames.length;
                // 遍历filenames并显示所有图片
                filenames.forEach(filename => {
                    displayImage(filename, zip);
                });
                loadingElement.style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                alert("加载漫画失败");
            });
    }

    // 其他函数保持不变...

    // 修改滚动事件监听器
    comicContainer.addEventListener('scroll', function() {
        var scrollTop = comicContainer.scrollTop;
        var scrollHeight = comicContainer.scrollHeight;
        var clientHeight = comicContainer.clientHeight;

        // 检查是否到达底部并加载下一张图片
        if (scrollTop + clientHeight >= scrollHeight - 100) { // 100是经验值，用于提前加载下一张图片
            if (currentPageIndex < pageCount - 1) {
                currentPageIndex++; // 更新当前页面索引
                var nextPageFilename = filenames[currentPageIndex];
                displayImage(nextPageFilename, zip);
            }
        }
    });

    // 页面加载后自动加载漫画
    loadComic();
</script>
</body>
</html>
