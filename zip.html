<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>漫画阅读器</title>
    <style>
        #comic {
            width: 100%;
            height: auto; /* 根据需要调整 */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        #comic img {
            max-width: 100%;
            max-height: 100%;
        }
        #loading {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="loading">加载中...</div>
    <div id="comic"></div>
    <!-- 引入 JSZip 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script>
        // 获取URL参数中的漫画URL
        var urlParams = new URLSearchParams(window.location.search);
        var comicUrl = urlParams.get('comic_url');

        // 加载ZIP文件中的漫画
        function loadComic(comicUrl) {
            fetch(comicUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.blob();
                })
                .then(blob => JSZip.loadAsync(blob))
                .then(zip => {
                    if (!zip) {
                        throw new Error('Failed to load zip file');
                    }
                    return loadPages(zip);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("加载漫画失败");
                });
        }
        
        function loadPages(zip) {
            var comicContainer = document.getElementById("comic");
            var loadingElement = document.getElementById("loading");
        
            var filenames = Object.keys(zip.files).filter(name => 
                !zip.files[name].dir && /\.(jpg|jpeg|png|gif)$/i.test(name)
            );
            filenames.sort();
        
            var promises = filenames.map(filename => {
                // 确保文件存在于 ZIP 中
                if (!zip.files[filename]) {
                    return Promise.reject(new Error(`File ${filename} does not exist in the zip`));
                }
                return zip.file(filename).async("base64").then(base64 => {
                    var img = new Image();
                    img.src = "data:image/jpeg;base64," + base64;
                    return new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = () => reject(new Error(`Failed to load image: ${filename}`));
                    });
                });
            });

            // 等待所有图片加载完成
            Promise.all(promises)
                .then(images => {
                    loadingElement.style.display = 'none';
                    images.forEach(img => {
                        var pageDiv = document.createElement("div");
                        pageDiv.className = "comic-page";
                        pageDiv.appendChild(img);
                        comicContainer.appendChild(pageDiv);
                    });
                })
                .catch(error => {
                    console.error('Error loading images:', error);
                    alert("加载图片失败");
                });
        }

        // 监听键盘事件实现翻页
        document.addEventListener("keydown", function(event) {
            var pages = document.querySelectorAll("#comic .comic-page");
            var currentIndex = Array.prototype.indexOf.call(pages, document.querySelector("#comic .comic-page:visible"));
            if (event.keyCode === 37) { // 左箭头 - 上一页
                if (currentIndex > 0) pages[currentIndex - 1].scrollIntoView();
            } else if (event.keyCode === 39) { // 右箭头 - 下一页
                if (currentIndex < pages.length - 1) pages[currentIndex + 1].scrollIntoView();
            }
        });

        // 页面加载后自动加载漫画
        loadComic(comicUrl);
    </script>
</body>
</html>
